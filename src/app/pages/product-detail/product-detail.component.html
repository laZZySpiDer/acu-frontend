<main class="container py-8 mt-20" *ngIf="product">
  <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
    <!-- Left Side: Product Images -->
    <div>
      <div class="relative overflow-hidden rounded-lg mb-4">
        <img [src]="selectedImage?.imageLink" [alt]="'Alt Description'" class="w-full h-[500px] object-cover" />
        <!-- Image Zoom Overlay -->
        <div
          class="absolute inset-0 bg-black opacity-0 hover:opacity-50 transition-opacity cursor-zoom-in flex items-center justify-center"
          (click)="openLightbox(product.generalImages.indexOf(selectedImage!))">
          <i class="fas fa-expand text-white text-4xl opacity-0 hover:opacity-100 transition-opacity"></i>
        </div>
      </div>
      <!-- Thumbnails -->
      <div class="grid grid-cols-4 gap-2">
        <button *ngFor="let image of product.generalImages" (click)="selectedImage = image"
          class="rounded-lg overflow-hidden" [class.ring-2]="selectedImage?.imageLink === image.imageLink"
          [class.ring-primary]="selectedImage?.imageLink === image.imageLink">
          <img [src]="image.imageLink" [alt]="product.name" class="w-full h-24 object-cover" />
        </button>
      </div>
    </div>

    <!-- Right Side: Product Details -->
    <div>
      <div class="flex justify-between items-start mb-4">
        <h1 class="text-3xl font-bold mb-4">{{ product.name }}</h1>
        <button (click)="toggleWishlist()" class="text-2xl" [class.text-red-500]="isInWishlist"
          [class.text-gray-400]="!isInWishlist">
          <i class="fas fa-heart"></i>
        </button>
      </div>

      <!-- Rating -->
      <div class="flex items-center mb-4" *ngIf="product.ratingsCount && product.ratingsCount > 0">
        <div class="flex text-yellow-400">
          <i *ngFor="let star of [1, 2, 3, 4, 5]" class="fas fa-star" [class.text-gray-300]="
              product.averageRating && product.averageRating < star
            "></i>
        </div>
        <span class="ml-2 text-gray-600">{{ product.ratingsCount }} review(s)</span>
      </div>

      <!-- Price -->
      <div class="mb-6">
        <ng-container *ngIf="product.salePrice">
          <span class="text-2xl font-bold text-primary mr-3">₹{{ product.salePrice }}</span>
          <span class="text-xl text-gray-400 line-through">₹{{ product.price }}</span>
        </ng-container>
        <ng-container *ngIf="!product.salePrice">
          <p class="text-2xl font-bold text-primary">₹{{ product.price }}</p>
        </ng-container>
      </div>

      <!-- Description -->
      <p *ngIf="selectedSize?.shortDescription" class="font-bold text-gray-800 mb-2">
        {{ selectedSize.shortDescription }}
      </p>
      <div class="mb-6">
        <p class="text-gray-600 whitespace-pre-line" [class.line-clamp-3]="!isDescriptionExpanded">
          {{ product.description }}
        </p>
        <button *ngIf="product.description && product.description.length > 100" (click)="toggleDescription()"
          class="text-primary font-medium text-sm mt-1 hover:underline focus:outline-none">
          {{ isDescriptionExpanded ? 'Read Less' : 'Read More' }}
        </button>
      </div>

      <!-- Color Selection -->
      <!-- <div *ngIf="product.colors" class="mb-6">
                <h3 class="font-semibold mb-2">Color</h3>
                <div class="flex gap-2">
                    <button *ngFor="let color of product.colors" (click)="selectedColor = color"
                        [class.ring-2]="selectedColor === color" [class.ring-primary]="selectedColor === color"
                        class="w-8 h-8 rounded-full" [style.background-color]="color">
                    </button>
                </div>
            </div> -->

      <!-- Size Selection -->
      <div *ngIf="product.sizes" class="mb-6">
        <!-- <h3 class="font-semibold mb-2">Size</h3> -->
        <h3 class="font-semibold mb-2">{{ product.category.id === 7 ? 'Size' : 'Variants' }}</h3>
        <div class="flex gap-2 flex-wrap">
          <button *ngFor="let size of product.sizes" (click)="changeSizeOfProduct(size)" [class.bg-primary]="
              selectedSize.productVariantId === size.productVariantId
            " [class.text-white]="
              selectedSize.productVariantId === size.productVariantId
            " class="px-4 py-2 border rounded-md hover:border-primary">
            {{ size.size }}
          </button>
        </div>
      </div>

      <!-- Quantity -->
      <div class="mb-6">
        <h3 class="font-semibold mb-2">{{ product.category.id === 7 ? 'Dolls in box' : 'Quantity' }}</h3>
        <div class="flex items-center gap-2">
          <ng-container *ngIf="product.category.id !== 7">
            <button (click)="quantity = Math.max(1, quantity - 1)" class="px-3 py-1 border rounded-md">
              <i class="fas fa-minus"></i>
            </button>
            <input type="number" [(ngModel)]="quantity" min="1" class="w-16 text-center border rounded-md px-2 py-1" />
            <button (click)="quantity = quantity + 1" class="px-3 py-1 border rounded-md">
              <i class="fas fa-plus"></i>
            </button>
          </ng-container>

          <select *ngIf="product.category.id === 7" (change)="quantityChange($event)" [(ngModel)]="quantity"
            class="border rounded-md px-2 py-1">
            <option *ngFor="let quantityType of quantityDropdownValuesForDolls"
              class="block px-4 py-2 text-sm text-gray-700" [value]="quantityType.value">
              {{ quantityType.label }}
            </option>
          </select>
        </div>
      </div>

      <!-- Custom Image Upload -->
      <div class="mb-6" *ngIf="requiresPhoto">
        <h3 class="font-semibold mb-2">Upload Photo <span class="text-red-500">*</span></h3>
        <p class="text-sm text-gray-500 mb-2">Please upload a photo for your custom product (PNG, JPG, JPEG).</p>

        <ng-container *ngIf="currentUser; else loginToUpload">
          <input *ngIf="!selectedCustomImage" type="file" (change)="onFileSelected($event)"
            accept="image/png, image/jpeg, image/jpg" class="block w-full text-sm text-gray-500
              file:mr-4 file:py-2 file:px-4
              file:rounded-full file:border-0
              file:text-sm file:font-semibold
              file:bg-primary file:text-white
              hover:file:bg-opacity-90
            " />

          <div *ngIf="selectedCustomImage" class="mt-2 flex items-start gap-4">
            <div>
              <p class="text-sm text-green-600 mb-1">Image selected!</p>
              <img [src]="selectedCustomImage" class="h-20 w-20 object-cover rounded border" alt="Preview">
            </div>
            <button (click)="removeImage()" class="text-red-500 hover:text-red-700 text-sm font-semibold mt-6">
              <i class="fas fa-trash-alt mr-1"></i> Remove
            </button>
          </div>
        </ng-container>

        <ng-template #loginToUpload>
          <div class="bg-gray-50 border-l-4 border-yellow-400 p-4 rounded-r-lg">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <i class="fas fa-lock text-yellow-400"></i>
              </div>
              <div class="ml-3">
                <p class="text-sm text-yellow-700">
                  Please <a routerLink="/login" [queryParams]="{ returnUrl: router.url }"
                    class="font-bold underline hover:text-yellow-800 cursor-pointer">log in</a>
                  to upload a photo for this product.
                </p>
              </div>
            </div>
          </div>
        </ng-template>
      </div>

      <!-- Add to Cart & Buy Now -->
      <div class="flex gap-4 mb-8">
        <button (click)="addToCart()" class="flex-1 btn-primary">
          Add to Cart
        </button>
        <button (click)="buyNow()" class="flex-1 btn-secondary">Buy Now</button>
      </div>

      <!-- Product Details -->
      <div class="border-t pt-6">
        <h3 class="font-semibold mb-4">Product Details</h3>
        <dl class="grid grid-cols-1 gap-2">
          <div class="grid grid-cols-2">
            <dt class="text-gray-600">Material</dt>
            <dd>{{ product.material }}</dd>
          </div>
          <div class="grid grid-cols-2">
            <dt class="text-gray-600">Dimensions</dt>
            <dd>{{ product.dimensions }}</dd>
          </div>
          <div class="grid grid-cols-2">
            <dt class="text-gray-600">Weight</dt>
            <dd>{{ product.weight }} kg</dd>
          </div>
        </dl>
      </div>
    </div>
  </div>

  <!-- Reviews Section -->
  <section class="mt-16">
    <h2 class="text-2xl font-bold mb-8">Customer Reviews</h2>

    <!-- Review Form -->
    <div *ngIf="currentUser; else loginPrompt" class="mb-8">
      <app-review-form [productId]="product.id" (submitted)="onReviewSubmitted($event)">
      </app-review-form>
    </div>

    <ng-template #loginPrompt>
      <div class="bg-gray-50 p-6 rounded-lg text-center mb-8">
        <p class="text-gray-600 mb-4">Please log in to write a review</p>
        <button class="btn-primary" routerLink="/login">Log In</button>
      </div>
    </ng-template>

    <!-- Review Stats -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8" *ngIf="product.comments && product.comments.length > 0">
      <div class="flex items-center gap-4">
        <div class="text-4xl font-bold">{{ product.averageRating }}</div>
        <div>
          <div class="flex text-yellow-400 mb-1">
            <i *ngFor="let star of [1, 2, 3, 4, 5]" class="fas fa-star" [class.text-gray-300]="
                product.averageRating && product.averageRating < star
              "></i>
          </div>
          <p class="text-gray-600">
            Based on {{ product.ratingsCount }} review(s)
          </p>
        </div>
      </div>
    </div>
    <!-- Individual Reviews -->
    <div class="space-y-6">
      <div *ngFor="let review of product.comments" class="border-b pb-6">
        <div class="flex items-center gap-4 mb-4">
          <img src="assets/images/avatars/{{review.userAvatar}}.webp" [alt]="review.userName"
            class="w-12 h-12 rounded-full object-cover" />
          <div>
            <h4 class="font-semibold">{{ review.userName }}</h4>
            <div class="flex text-yellow-400">
              <i *ngFor="let star of [1, 2, 3, 4, 5]" class="fas fa-star text-sm"
                [class.text-gray-300]="star > review.rating"></i>
            </div>
          </div>
          <span class="ml-auto text-gray-500">{{
            review.createdAt | date
            }}</span>
        </div>
        <p class="text-gray-600">{{ review.comment }}</p>
        <!-- Review Actions -->
        <!-- <div class="flex items-center gap-4">
          <button
            (click)="markHelpful(review)"
            class="text-sm text-gray-500 hover:text-primary"
          >
            <i class="fas fa-thumbs-up mr-1"></i>
            Helpful ({{ review.helpful }})
          </button>
          <button class="text-sm text-gray-500 hover:text-primary">
            <i class="fas fa-flag mr-1"></i>
            Report
          </button>
        </div> -->
      </div>
    </div>
  </section>

  <!-- Lightbox Modal -->
  <div *ngIf="isLightboxOpen"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-95 backdrop-blur-sm transition-opacity duration-300"
    (click)="closeLightbox()">

    <!-- Close Button -->
    <button
      class="absolute top-6 right-6 text-white text-5xl hover:text-gray-300 z-50 focus:outline-none transition-colors"
      (click)="closeLightbox()">
      &times;
    </button>

    <!-- Previous Button -->
    <button
      class="absolute left-4 md:left-8 text-white text-4xl md:text-6xl hover:text-gray-300 z-50 focus:outline-none p-4 transition-transform hover:scale-110"
      (click)="$event.stopPropagation(); prevLightboxImage()">
      <i class="fas fa-chevron-left"></i>
    </button>

    <!-- Image Container -->
    <div class="relative max-w-7xl max-h-[90vh]  flex flex-col items-center" (click)="$event.stopPropagation()">
      <img [src]="product.generalImages[currentLightboxIndex].imageLink" [alt]="product.name"
        class="max-w-full max-h-[80vh] object-contain rounded-lg shadow-2xl" />

      <!-- Image Counter & Thumbnails Preview (Optional, simple counter for now) -->
      <div class="mt-4 text-white text-lg font-medium tracking-wide">
        {{ currentLightboxIndex + 1 }} / {{ product.generalImages.length }}
      </div>

      <!-- Small Thumbnails Strip at bottom of lightbox -->
      <div class="flex gap-2 mt-4 overflow-x-auto max-w-full px-4 pb-2">
        <button *ngFor="let img of product.generalImages; let i = index" (click)="currentLightboxIndex = i"
          class="relative w-16 h-16 rounded-md overflow-hidden border-2 transition-all"
          [class.border-white]="i === currentLightboxIndex" [class.border-transparent]="i !== currentLightboxIndex"
          [class.opacity-50]="i !== currentLightboxIndex" [class.opacity-100]="i === currentLightboxIndex">
          <img [src]="img.imageLink" class="w-full h-full object-cover">
        </button>
      </div>
    </div>

    <!-- Next Button -->
    <button
      class="absolute right-4 md:right-8 text-white text-4xl md:text-6xl hover:text-gray-300 z-50 focus:outline-none p-4 transition-transform hover:scale-110"
      (click)="$event.stopPropagation(); nextLightboxImage()">
      <i class="fas fa-chevron-right"></i>
    </button>

  </div>
</main>